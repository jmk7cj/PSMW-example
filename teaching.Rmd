---
title: 'Causal Inference: Introduction to Propensity Score Matching'
author: "Joseph Kush"
date: "12/3/2021"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#### Purpose: 
This R script introduces propensity score matching methods for causal inference. 
Example school-level data is then generated, in which there is imbalance on 
baseline covariates between schools implementing treatment versus control. After 
examining the extent of imbalance, propensity scores are estimated and schools 
are matched. Finally, the effect of treatment on the outcome of interest (read) 
is estimated and compared to the known population ATT. 

#### Data generation
First, load necessary libraries and set seed for reproducibility. 
```{r}
library("cobalt")
library("MatchIt")
library("survey")
set.seed(1234)
```
&nbsp;&nbsp;&nbsp;

In this example, we generate school-level covariates such as 
enrollment, student:teacher ratio, and % of students receiving
free and reduced-price meals for N = 1,000 schools. 
```{r}
# Generate school-level data
sample_size <- 1000
schID <- 1:sample_size 

enrollment <- as.integer(runif(n = sample_size, min = 100, max = 1000))
st_ratio <- rnorm(n = sample_size, mean = 0.2, sd = 0.05)
susp <- runif(n = sample_size, min = 0, max = 0.2)
farms <- rnorm(n = sample_size, mean = st_ratio, sd = 0.03)
sped <- rnorm(n = sample_size, mean = 0.15, sd = 0.03)
minority <- runif(n = sample_size, min = 0, max = 0.8)
ell <- rnorm(n = sample_size, mean = farms, sd = 0.02)
disable <- rnorm(n = sample_size, mean = 0.15, sd = 0.03)
math <- rnorm(n = sample_size, mean = 0.8, sd = 0.05)
```
&nbsp;&nbsp;&nbsp;

Next, a binary treatment indicator is generated for each school 
according to a treatment-selection model. Logit odds (x) are created
with a binary treatment indicator generated from a binomial distribution
with a probability of exposure equal to $\frac{e^x}{1+e^x}$. 
```{r}
# Create a binary treatment indicator
# First, create logit odds (hint: intercept sets treatment prevalence)
logit_treat <- 0.7 + 0*enrollment + 2.7*st_ratio + 1.9*susp + 1.3*farms + 
  9*sped*minority + 1.8*ell + 2.6*disable + -3.7*math 

# Next, convert logit odds into probability
prob_treat <- exp(logit_treat)/(1 + exp(logit_treat))

# Finally, generate binary treatment indicator from binomial 
# distribution of 1 trial with P = prob_treat
treat <- rbinom(sample_size, 1, prob_treat)

# Create potential outcomes for reading scores
treatment_effect <- 2

read_0 <- (80 + 0*treatment_effect + 
  0*enrollment + 2.7*st_ratio + 1.9*susp + 1.3*farms + 
  9*sped*minority + 1.8*ell + 2.6*disable + -3.7*math + 
  rnorm(n = sample_size, mean = 0, sd = 3)) / 100

read_1 <- (80 + 1*treatment_effect + 
  0*enrollment + 2.7*st_ratio + 1.9*susp + 1.3*farms + 
  9*sped*minority + 1.8*ell + 2.6*disable + -3.7*math + 
  rnorm(n = sample_size, mean = 0, sd = 3)) / 100

read <- ifelse(treat == 1, read_1, read_0)
```
&nbsp;&nbsp;&nbsp;

Everything is placed into a data.frame.
```{r}
# Combine all variables into a data frame 
df <- data.frame(cbind(schID, enrollment, st_ratio, susp, farms, sped, 
                       minority, ell, disable, math, treat, read))
summary(df) 
head(df)
# ------------------------------------------------------------------------ #
```
&nbsp;&nbsp;&nbsp;



#### Examine baseline imbalance and conduct matching
We start by fitting a linear model to our data. Because 
method = NULL, no propensity score matching is done 
(i.e., baseline model)
```{r}
# Because method = NULL, no propensity score matching 
# is done (i.e., baseline model)
baseline <- matchit(treat ~ enrollment + st_ratio + susp + farms + 
               sped + minority + ell + disable + math, 
               data = df, method = NULL)
```
&nbsp;&nbsp;&nbsp;


Let's examine standardized mean differences in covariates
```{r}
bal.tab(baseline, s.d.denom = "treat", m.threshold = 0.1)
```
&nbsp;&nbsp;&nbsp;


We can also plot our values.
```{r}
# Plot SMDs
love.plot(baseline, s.d.denom = "pooled", abs = T, 
          thresholds = 0.1, var.order = "unadjusted", drop.distance = T)
```
&nbsp;&nbsp;&nbsp;


Now we will estimate propensity scores and match accordingly. 
```{r}
# Conduct propensity score matching
m <- matchit(treat ~ enrollment + st_ratio + susp + farms + 
               sped + minority + ell + disable + math, 
             data = df, method = "nearest", replace = T, 
             ratio = 2, caliper = 0.1, std.caliper = T)
```
&nbsp;&nbsp;&nbsp;

Examine our output: how do things look after matching? 
```{r}
summary(m)

love.plot(m, s.d.denom = "pooled", abs = T, thresholds = 0.1, 
          var.order = "unadjusted", drop.distance = T)
```
&nbsp;&nbsp;&nbsp;

The standardized mean differences decreased for ever covariate 
except for 'disable' (although SMD < 0.1). 


&nbsp;&nbsp;&nbsp;


#### Estimate outcomes
Great - it looks like we have achieved balance on our covariates. 
Now let's estimate the treatment effect on reading outcomes. We begin
by retaining matched units only and including weights (as we 
matched with replacement).

```{r}
match_data <- match.data(m)

# Then use weights, as matching with replacement
mwr_data <- svydesign(ids=~1, weights =~ weights, data = match_data)
```
&nbsp;&nbsp;&nbsp;


Finally, we estimate the ATT (unadjusted such that treatment is
the only predictor).
```{r}
outcome_unadj <- svyglm(read ~ treat, mwr_data, family=gaussian())
```
&nbsp;&nbsp;&nbsp;


Before we examine our estimates, the potential outcomes
ATT = 0.0188. This can be interpretted as the true effect
of treatment (as we generated the data and know both
potential outcomes)
```{r}
pop_ATT <- by(read_1, treat, mean)[[2]] - by(read_0, treat, mean)[[2]]
pop_ATT
```
&nbsp;&nbsp;&nbsp;


Now we can examine bias in our propensity score matched
estimate of the treatment effect.
```{r}
# Matching estimates
round(summary(outcome_unadj)$coef, digits = 4)

bias_outcome_unadj <- (coef(outcome_unadj)["treat"] - pop_ATT) / pop_ATT
bias_outcome_unadj
```
&nbsp;&nbsp;&nbsp;

Not bad, about 6.1% bias.
Out of curisoity, what would our estimated treatment effect
be had we not used propensity score matching, but fit
a regression model in which we adjusted for covariates
including treatment?
```{r}
# Compare to estimates from basic regression adjustment
reg_adj <- lm(read ~ treat + enrollment + st_ratio + susp + farms + 
                sped + minority + ell + disable + math, data = df)
round(summary(reg_adj)$coef, digits = 4)

bias_reg_adj <- (coef(reg_adj)["treat"] - pop_ATT) / pop_ATT
bias_reg_adj
# ------------------------------------------------------------------------ #
```
&nbsp;&nbsp;&nbsp;

While our PSM estimate is 6.1% biased, 
the regression adjustment estimate is 11.5% biased.


